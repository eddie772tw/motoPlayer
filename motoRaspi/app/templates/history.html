<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>騎行日誌 - MotoPlayer</title>
    <!-- 專案既有的 CSS 引用 -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/font.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Flash 訊息的專屬樣式 */
        .flashes {
            list-style: none;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border-radius: 0.5rem;
            font-weight: 500;
        }
        .flashes li {
            padding: 0;
            margin: 0;
        }
        /* 成功訊息樣式 */
        .flash-success {
            background-color: #1a3c31;
            border-left: 6px solid #34d399;
            color: #a7f3d0;
        }
        /* 錯誤訊息樣式 */
        .flash-error {
            background-color: #4a1d1d;
            border-left: 6px solid #f87171;
            color: #fecaca;
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        <header class="mb-6 flex justify-between items-center">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white">騎行日誌</h1>
                <p class="text-gray-400">所有歷史騎行紀錄</p>
            </div>
            <!-- 按鈕區塊 -->
            <div class="space-x-4">
                <!-- 新增的匯入日誌按鈕 -->
                <button id="import-log-btn" class="px-4 py-2 bg-green-600 text-white font-semibold rounded-lg hover:bg-green-700 transition-colors">
                    匯入日誌
                </button>
                <a href="/" class="px-4 py-2 bg-cyan-600 text-white font-semibold rounded-lg hover:bg-cyan-700 transition-colors">
                    返回即時儀表板
                </a>
            </div>
        </header>

        <!-- Flask Flash 訊息顯示區塊 -->
        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <ul class="flashes flash-{{ category or 'info' }}">
                <li>{{ message }}</li>
              </ul>
            {% endfor %}
          {% endif %}
        {% endwith %}

        <!-- 隱藏的檔案上傳表單 -->
        <form id="upload-form" action="{{ url_for('main.upload_log') }}" method="post" enctype="multipart/form-data" style="display: none;">
            <input type="file" name="log_file" id="log-file-input" accept=".csv">
        </form>

        <main class="bg-gray-800 p-4 rounded-xl shadow-lg">
            <div class="overflow-x-auto">
                <table class="min-w-full divide-y divide-gray-700">
                    <thead class="bg-gray-700">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">騎行 ID</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">開始時間</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">結束時間</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">最高時速 (km/h)</th>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-300 uppercase tracking-wider">數據點</th>
                            <th scope="col" class="relative px-6 py-3">
                                <span class="sr-only">操作</span>
                            </th>
                        </tr>
                    </thead>
                    <tbody id="history-table-body" class="bg-gray-800 divide-y divide-gray-700">
                        <tr>
                            <td colspan="6" class="px-6 py-12 text-center text-gray-400">
                                <div id="loading-indicator">正在載入歷史紀錄...</div>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </main>
    </div>

    <script>
        // --- 整合後的 JavaScript ---

        // 處理檔案上傳的邏輯
        document.getElementById('import-log-btn').addEventListener('click', function() {
            document.getElementById('log-file-input').click();
        });

        document.getElementById('log-file-input').addEventListener('change', function() {
            if (this.files.length > 0) {
                document.getElementById('upload-form').submit();
            }
        });

        // 您既有的動態載入與刪除邏輯
        const tableBody = document.getElementById('history-table-body');
        const loadingIndicator = document.getElementById('loading-indicator');
        let activeConfirmButton = null;

        const fetchHistory = async () => {
            try {
                const response = await fetch(`/api/trip_history?_=${new Date().getTime()}`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const historyData = await response.json();
                
                tableBody.innerHTML = '';

                if (historyData.length === 0) {
                    tableBody.innerHTML = `<tr><td colspan="6" class="px-6 py-12 text-center text-gray-400">沒有任何歷史紀錄。</td></tr>`;
                    return;
                }

                historyData.forEach(trip => {
                    const startTime = new Date(trip.start_time).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' });
                    const endTime = new Date(trip.end_time).toLocaleString('zh-TW', { timeZone: 'Asia/Taipei' });

                    const row = `
                        <tr class="hover:bg-gray-700 transition-colors" id="trip-row-${trip.trip_id}">
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-white">${trip.trip_id}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${startTime}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${endTime}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-green-400">${trip.max_speed ? trip.max_speed.toFixed(1) : 'N/A'}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-300">${trip.data_points}</td>
                            <td class="px-6 py-4 whitespace-nowrap text-right text-sm font-medium space-x-4">
                                <a href="/trip/${trip.trip_id}" class="text-cyan-400 hover:text-cyan-300">查看詳情</a>
                                <button class="text-red-500 hover:text-red-400 delete-btn" data-trip-id="${trip.trip_id}">刪除</button>
                            </td>
                        </tr>
                    `;
                    tableBody.innerHTML += row;
                });

            } catch (error) {
                console.error("無法獲取歷史紀錄:", error);
                const loadingCell = tableBody.querySelector('td');
                if(loadingCell) {
                    loadingCell.textContent = '載入失敗，請稍後再試。';
                    loadingCell.classList.add('text-red-400');
                }
            }
        };

        tableBody.addEventListener('click', async (event) => {
            const target = event.target;
            if (!target.classList.contains('delete-btn')) return;

            const tripId = target.dataset.tripId;

            if (target === activeConfirmButton) {
                try {
                    target.textContent = '刪除中...';
                    target.disabled = true;

                    const response = await fetch(`/api/trip/${tripId}`, { method: 'DELETE' });
                    const result = await response.json();

                    if (response.ok && result.status === 'success') {
                        document.getElementById(`trip-row-${tripId}`).remove();
                    } else {
                        throw new Error(result.message || '刪除失敗');
                    }
                } catch (error) {
                    console.error('刪除操作失敗:', error);
                    alert(`刪除失敗: ${error.message}`);
                    target.textContent = '刪除';
                    target.disabled = false;
                }
            } else {
                if (activeConfirmButton) {
                    activeConfirmButton.textContent = '刪除';
                    activeConfirmButton.classList.remove('bg-red-600', 'text-white', 'px-2', 'py-1', 'rounded');
                }
                
                target.textContent = '確認刪除?';
                target.classList.add('bg-red-600', 'text-white', 'px-2', 'py-1', 'rounded');
                activeConfirmButton = target;

                setTimeout(() => {
                    if (activeConfirmButton === target) {
                        target.textContent = '刪除';
                        target.classList.remove('bg-red-600', 'text-white', 'px-2', 'py-1', 'rounded');
                        activeConfirmButton = null;
                    }
                }, 3000);
            }
        });

        fetchHistory();
    </script>
</body>
</html>
