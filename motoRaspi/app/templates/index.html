<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MotoPlayer 即時儀表板 v3</title>
    <!-- [修正] 將 fonts.css 更正為 font.css -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/font.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}">
    <script src="{{ url_for('static', filename='js/echarts.min.js') }}"></script>
    <script src="{{ url_for('static', filename='js/socket.io.min.js') }}"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .echart-container {
            width: 100%;
            height: 16rem; /* 256px */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        <header class="mb-6 flex flex-wrap justify-between items-center gap-4">
            <div>
                <h1 class="text-3xl md:text-4xl font-bold text-white">MotoPlayer 即時儀表板</h1>
                <p class="text-gray-400">性能數據分析模式</p>
            </div>
            <div class="flex items-center space-x-4">
                <div class="flex items-center space-x-2">
                    <span id="wsStatusIndicator" class="h-4 w-4 rounded-full bg-gray-600 transition-colors duration-500"></span>
                    <span id="wsStatusText" class="text-gray-400">未連線</span>
                </div>
                <a href="/history" class="px-4 py-2 bg-cyan-600 text-white font-semibold rounded-lg hover:bg-cyan-700 transition-colors">
                    查看騎行日誌
                </a>
            </div>
        </header>

        <main class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
            
            <!-- [修正] 新增 col-span-2 和 md:col-span-4 讓此容器橫跨整個寬度 -->
            <div class="col-span-2 md:col-span-4 grid grid-cols-2 gap-4 md:gap-6">
                <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold text-purple-400 mb-2">節氣門位置 (%)</h2>
                    <div id="throttleGauge" class="echart-container"></div>
                </div>

                <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                    <h2 class="text-lg font-semibold text-yellow-400 mb-2">引擎負荷 (%)</h2>
                    <div id="loadGauge" class="echart-container"></div>
                </div>
            </div>

            <div class="bg-gray-800 p-4 rounded-xl shadow-lg flex flex-col items-center justify-center">
                <h2 class="text-lg font-semibold text-gray-400 mb-2">時速 (km/h)</h2>
                <p id="speedDisplay" class="text-7xl font-black text-white tabular-nums">--</p>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg flex flex-col items-center justify-center">
                <h2 class="text-lg font-semibold text-gray-400 mb-2">轉速 (RPM)</h2>
                <p id="rpmDisplay" class="text-7xl font-black text-white tabular-nums">--</p>
            </div>

            <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                <h2 class="text-lg font-semibold text-gray-400 mb-2">引擎水溫</h2>
                <p class="text-4xl font-bold text-red-400"><span id="coolantTempDisplay">--</span> &deg;C</p>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                <h2 class="text-lg font-semibold text-gray-400 mb-2">電瓶電壓</h2>
                <p class="text-4xl font-bold text-yellow-400"><span id="voltageDisplay">--</span> V</p>
            </div>

            <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                <h2 class="text-lg font-semibold text-gray-400 mb-2">體感溫度</h2>
                <p class="text-4xl font-bold text-purple-400"><span id="feelsLikeDisplay">--</span> &deg;C</p>
            </div>
             <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                <h2 class="text-lg font-semibold text-gray-400 mb-2">環境溫度</h2>
                <p class="text-4xl font-bold text-blue-400"><span id="envTempDisplay">--</span> &deg;C</p>
            </div>
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                <h2 class="text-lg font-semibold text-gray-400 mb-2">環境濕度</h2>
                <p class="text-4xl font-bold text-indigo-400"><span id="humidityDisplay">--</span> %</p>
            </div>

            <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                <h2 class="text-lg font-semibold text-gray-400 mb-2">系統狀態</h2>
                <div class="flex items-center mt-4">
                    <span id="unoStatusIndicator" class="h-4 w-4 rounded-full bg-gray-600 mr-2"></span>
                    <span id="unoStatusText" class="text-xl text-gray-400">未知</span>
                </div>
            </div>
        </main>
    </div>
    <script>
        const speedDisplay = document.getElementById('speedDisplay');
        const rpmDisplay = document.getElementById('rpmDisplay');
        const coolantTempDisplay = document.getElementById('coolantTempDisplay');
        const voltageDisplay = document.getElementById('voltageDisplay');
        const unoStatusIndicator = document.getElementById('unoStatusIndicator');
        const unoStatusText = document.getElementById('unoStatusText');
        const envTempDisplay = document.getElementById('envTempDisplay');
        const feelsLikeDisplay = document.getElementById('feelsLikeDisplay');
        const humidityDisplay = document.getElementById('humidityDisplay');
        const wsStatusIndicator = document.getElementById('wsStatusIndicator');
        const wsStatusText = document.getElementById('wsStatusText');
        
        const throttleGauge = echarts.init(document.getElementById('throttleGauge'));
        const loadGauge = echarts.init(document.getElementById('loadGauge'));
        
        const getGaugeOption = (value, name, color, min, max, split) => ({
            series: [{
                type: 'gauge',
                center: ['50%', '60%'],
                radius: '95%',
                startAngle: 200, endAngle: -20,
                min: min, max: max, splitNumber: split,
                itemStyle: { color: color },
                progress: { show: true, width: 18 },
                pointer: { show: false },
                axisLine: { lineStyle: { width: 18 } },
                axisTick: { show: false },
                splitLine: { distance: -28, length: 12, lineStyle: { color: '#fff', width: 2 } },
                axisLabel: { distance: -5, color: '#fff', fontSize: 12 },
                anchor: { show: false },
                title: { show: false },
                detail: {
                    valueAnimation: true,
                    fontSize: 40,
                    fontWeight: 'bolder',
                    color: '#fff',
                    offsetCenter: [0, '0%'],
                    formatter: '{value}%'
                },
                data: [{ value: value, name: name }]
            }]
        });

        const updateUI = (data) => {
            throttleGauge.setOption(getGaugeOption(data.throttle_pos?.toFixed(1) ?? 0, '節氣門', '#A78BFA', 0, 100, 10));
            loadGauge.setOption(getGaugeOption(data.engine_load?.toFixed(1) ?? 0, '引擎負荷', '#FBBF24', 0, 100, 10));

            speedDisplay.textContent = data.speed ?? '--';
            rpmDisplay.textContent = data.rpm ?? '--';
            coolantTempDisplay.textContent = data.coolant_temp?.toFixed(1) ?? '--';
            voltageDisplay.textContent = data.battery_voltage?.toFixed(2) ?? '--';
            envTempDisplay.textContent = data.temperature?.toFixed(1) ?? '--';
            feelsLikeDisplay.textContent = data.feels_like?.toFixed(1) ?? '--';
            humidityDisplay.textContent = data.humidity?.toFixed(1) ?? '--';
            
            if (data.uno_status === 'Online') {
                unoStatusIndicator.className = 'h-4 w-4 rounded-full bg-green-500 mr-2';
                unoStatusText.textContent = '連線正常';
                unoStatusText.className = 'text-green-400';
            } else {
                unoStatusIndicator.className = 'h-4 w-4 rounded-full bg-red-500 mr-2';
                unoStatusText.textContent = '連線中斷';
                unoStatusText.className = 'text-red-400';
            }
        };

        const socket = io();
        socket.on('connect', () => {
            wsStatusIndicator.className = 'h-4 w-4 rounded-full bg-green-500';
            wsStatusText.textContent = '已連線';
        });
        socket.on('disconnect', () => {
            wsStatusIndicator.className = 'h-4 w-4 rounded-full bg-red-500';
            wsStatusText.textContent = '已斷線';
        });
        socket.on('update_data', (data) => {
            updateUI(data);
        });

        window.addEventListener('resize', () => {
            throttleGauge.resize();
            loadGauge.resize();
        });

        updateUI({});

    </script>
</body>
</html>
