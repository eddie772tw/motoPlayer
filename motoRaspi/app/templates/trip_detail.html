<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>騎行詳情 - MotoPlayer</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/font.css') }}">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/echarts@5.4.3/dist/echarts.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/socket.io@4.7.2/client-dist/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns@3.0.0/dist/chartjs-adapter-date-fns.bundle.min.js"></script>
	<script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .toggle-btn { opacity: 0.5; transition: all 0.2s ease-in-out; }
        .toggle-btn.active { opacity: 1; transform: scale(1.05); box-shadow: 0 0 10px rgba(255, 255, 255, 0.3); }
        .chart-container {
            height: 24rem; /* 384px */
        }
    </style>
</head>
<body class="bg-gray-900 text-gray-200">
    <div class="container mx-auto p-4 md:p-6 lg:p-8">
        <header class="mb-6">
            <div class="flex flex-wrap justify-between items-center gap-4">
                <div>
                    <h1 class="text-3xl md:text-4xl font-bold text-white">騎行詳情</h1>
                    <p id="trip-subtitle" class="text-gray-400">正在載入 Trip ID: {{ trip_id }} 的數據...</p>
                </div>
                <div class="flex items-center space-x-2">
                    <a id="export-csv-btn" href="#" class="px-4 py-2 bg-gray-600 text-white font-semibold rounded-lg hover:bg-gray-700 transition-colors">
                        匯出 CSV
                    </a>
                    <a href="/history" class="px-4 py-2 bg-cyan-600 text-white font-semibold rounded-lg hover:bg-cyan-700 transition-colors">
                        返回日誌列表
                    </a>
                </div>
            </div>
        </header>

        <main id="charts-container" class="space-y-6">
            <!-- [修改] 新增數據卡片網格 -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                <div class="bg-gray-800 p-4 rounded-xl shadow-lg text-center">
                    <h2 class="text-sm font-semibold text-gray-400 mb-1">點火提前角</h2>
                    <p id="timing-advance-card" class="text-2xl font-bold text-white">--</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl shadow-lg text-center">
                    <h2 class="text-sm font-semibold text-gray-400 mb-1">燃油系統狀態</h2>
                    <p id="fuel-system-card" class="text-lg font-bold text-white">--</p>
                </div>
                <div class="bg-gray-800 p-4 rounded-xl shadow-lg text-center">
                     <h2 class="text-sm font-semibold text-gray-400 mb-1">O2 感測器電壓</h2>
                     <p id="o2-voltage-card" class="text-2xl font-bold text-white">-- V</p>
                </div>
                 <div class="bg-gray-800 p-4 rounded-xl shadow-lg text-center">
                     <h2 class="text-sm font-semibold text-gray-400 mb-1">取樣頻率 (秒)</h2>
                     <input type="number" id="sampling-interval" value="1" min="1" class="bg-gray-700 text-white rounded w-full text-center text-2xl font-bold">
                </div>
            </div>

            <!-- [修改] 將圖表拆分為多個邏輯群組 -->
            <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                <div class="flex flex-wrap justify-between items-center mb-4 gap-4">
                    <h2 class="text-lg font-semibold text-white">動力數據 (Speed / RPM / Throttle)</h2>
                    <div id="toggle-buttons-power" class="flex space-x-2">
                        <button data-chart="powerChart" data-dataset-index="0" class="toggle-btn active px-3 py-1 text-sm font-medium rounded-full bg-green-500 text-white">時速</button>
                        <button data-chart="powerChart" data-dataset-index="1" class="toggle-btn active px-3 py-1 text-sm font-medium rounded-full bg-cyan-500 text-white">轉速</button>
                        <button data-chart="powerChart" data-dataset-index="2" class="toggle-btn active px-3 py-1 text-sm font-medium rounded-full bg-purple-500 text-white">節氣門</button>
                    </div>
                </div>
                <div class="relative chart-container">
                    <canvas id="powerChart"></canvas>
                </div>
            </div>

            <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                <h2 class="text-lg font-semibold text-yellow-400 mb-2">引擎負荷 (%)</h2>
                <div class="relative chart-container">
                    <canvas id="loadChart"></canvas>
                </div>
            </div>

            <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                <h2 class="text-lg font-semibold text-red-400 mb-2">溫度 (°C)</h2>
                <div class="relative chart-container">
                    <canvas id="tempChart"></canvas>
                </div>
            </div>

            <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                <h2 class="text-lg font-semibold text-blue-400 mb-2">壓力 (kPa) & 電壓 (V)</h2>
                <div class="relative chart-container">
                    <canvas id="pressureVoltageChart"></canvas>
                </div>
            </div>

            <div class="bg-gray-800 p-4 rounded-xl shadow-lg">
                <h2 class="text-lg font-semibold text-indigo-400 mb-2">燃油修正 (%)</h2>
                <div class="relative chart-container">
                    <canvas id="fuelTrimChart"></canvas>
                </div>
            </div>
        </main>
        
        <div id="loading-indicator" class="text-center py-12 text-gray-400"></div>
    </div>

    <script>
        const tripId = {{ trip_id }};
        const subtitle = document.getElementById('trip-subtitle');
        const chartsContainer = document.getElementById('charts-container');
        const loadingIndicator = document.getElementById('loading-indicator');
        const samplingInput = document.getElementById('sampling-interval');
        const exportBtn = document.getElementById('export-csv-btn');

        // [修改] 圖表物件列表
        let charts = {};
        let originalTripData = [];

        // [修改] 同步所有圖表的縮放/平移
        const syncCharts = (sourceChart) => {
            if (!sourceChart) return;
            const { min, max } = sourceChart.scales.x;
            Object.values(charts).forEach(targetChart => {
                if (targetChart && targetChart.canvas.id !== sourceChart.canvas.id) {
                    if (targetChart.scales.x.min !== min || targetChart.scales.x.max !== max) {
                        targetChart.scales.x.min = min;
                        targetChart.scales.x.max = max;
                        targetChart.update('none');
                    }
                }
            });
        };
        
        const createLineChart = (ctx, data, options) => new Chart(ctx, { type: 'line', data, options });

        const redrawCharts = () => {
            if (!originalTripData.length) return;

            // 銷毀所有舊圖表
            Object.values(charts).forEach(chart => chart.destroy());
            charts = {};

            const interval = parseInt(samplingInput.value, 10) || 1;
            const aggregatedTripData = aggregateDataByTime(originalTripData, interval);
            
            const startTime = new Date(originalTripData[0].timestamp);
            subtitle.textContent = `開始於 ${startTime.toLocaleString('zh-TW')} (每 ${interval} 秒聚合為 ${aggregatedTripData.length} 個數據點)`;

            // 更新數據卡片 (使用最後一筆聚合數據)
            const lastPoint = aggregatedTripData[aggregatedTripData.length - 1] || {};
            document.getElementById('timing-advance-card').textContent = lastPoint.timing_advance?.toFixed(1) ?? '--';
            document.getElementById('fuel-system-card').textContent = lastPoint.fuel_system_status ?? '--';
            document.getElementById('o2-voltage-card').textContent = `${lastPoint.o2_sensor_voltage_b1s1?.toFixed(3) ?? '--'} V`;


            const getChartOptions = (yAxesConfig, onZoomPan) => ({
                responsive: true, maintainAspectRatio: false,
                scales: { x: { type: 'time', time: { unit: 'minute', tooltipFormat: 'yyyy-MM-dd HH:mm:ss' }, ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } }, ...yAxesConfig },
                plugins: { legend: { labels: { color: '#D1D5DB' } }, zoom: { pan: { enabled: true, mode: 'x', onPanComplete: onZoomPan }, zoom: { wheel: { enabled: true, speed: 0.1 }, mode: 'x', onZoomComplete: onZoomPan } } },
                interaction: { intersect: false, mode: 'index' },
            });
            
            const onZoomPan = ({ chart }) => syncCharts(chart);

            // --- 1. 動力圖表 ---
            charts.powerChart = createLineChart(document.getElementById('powerChart').getContext('2d'), {
                datasets: [
                    { label: '時速 (km/h)', data: aggregatedTripData.map(d => ({x: new Date(d.timestamp), y: d.speed})), borderColor: '#4ADE80', yAxisID: 'y' },
                    { label: '轉速 (RPM)', data: aggregatedTripData.map(d => ({x: new Date(d.timestamp), y: d.rpm})), borderColor: '#22D3EE', yAxisID: 'y1' },
                    { label: '節氣門 (%)', data: aggregatedTripData.map(d => ({x: new Date(d.timestamp), y: d.throttle_pos})), borderColor: '#A78BFA', yAxisID: 'y' } 
                ]
            }, getChartOptions({
                y: { position: 'left', beginAtZero: true, ticks: { color: '#9CA3AF' }, grid: { color: '#374151' } },
                y1: { position: 'right', beginAtZero: true, ticks: { color: '#22D3EE' }, grid: { drawOnChartArea: false }, title: { display: true, text: '轉速 (RPM)', color: '#22D3EE' } }
            }, onZoomPan));

            // --- 2. 引擎負荷圖表 ---
            charts.loadChart = createLineChart(document.getElementById('loadChart').getContext('2d'), {
                datasets: [
                    { label: '計算出的引擎負荷 (%)', data: aggregatedTripData.map(d => ({x: new Date(d.timestamp), y: d.engine_load})), borderColor: '#FBBF24' },
                    { label: '絕對負荷值 (%)', data: aggregatedTripData.map(d => ({x: new Date(d.timestamp), y: d.abs_load_val})), borderColor: '#F87171', borderDash: [5, 5] }
                ]
            }, getChartOptions({ y: { beginAtZero: true, max: 100, ticks: { color: '#9CA3AF' } } }, onZoomPan));

            // --- 3. 溫度圖表 ---
            charts.tempChart = createLineChart(document.getElementById('tempChart').getContext('2d'), {
                datasets: [
                    { label: '引擎水溫', data: aggregatedTripData.map(d => ({x: new Date(d.timestamp), y: d.coolant_temp})), borderColor: '#F87171' },
                    { label: '進氣溫度', data: aggregatedTripData.map(d => ({x: new Date(d.timestamp), y: d.intake_air_temp})), borderColor: '#FBBF24' },
                    { label: '環境溫度', data: aggregatedTripData.map(d => ({x: new Date(d.timestamp), y: d.temperature})), borderColor: '#60A5FA' }
                ]
            }, getChartOptions({ y: { beginAtZero: false, ticks: { color: '#9CA3AF' } } }, onZoomPan));

            // --- 4. 壓力與電壓圖表 ---
            charts.pressureVoltageChart = createLineChart(document.getElementById('pressureVoltageChart').getContext('2d'), {
                datasets: [
                    { label: '進氣歧管壓力 (kPa)', data: aggregatedTripData.map(d => ({x: new Date(d.timestamp), y: d.intake_map})), borderColor: '#34D399', yAxisID: 'y' },
                    { label: '電瓶電壓 (V)', data: aggregatedTripData.map(d => ({x: new Date(d.timestamp), y: d.battery_voltage})), borderColor: '#FCD34D', yAxisID: 'y1' }
                ]
            }, getChartOptions({
                y: { position: 'left', beginAtZero: true, ticks: { color: '#34D399' }, title: { display: true, text: '壓力 (kPa)', color: '#34D399' } },
                y1: { position: 'right', beginAtZero: false, ticks: { color: '#FCD34D' }, grid: { drawOnChartArea: false }, title: { display: true, text: '電壓 (V)', color: '#FCD34D' } }
            }, onZoomPan));

            // --- 5. 燃油修正圖表 ---
            charts.fuelTrimChart = createLineChart(document.getElementById('fuelTrimChart').getContext('2d'), {
                datasets: [
                    { label: '短期燃油修正 (%)', data: aggregatedTripData.map(d => ({x: new Date(d.timestamp), y: d.short_term_fuel_trim_b1})), borderColor: '#818CF8' },
                    { label: '長期燃油修正 (%)', data: aggregatedTripData.map(d => ({x: new Date(d.timestamp), y: d.long_term_fuel_trim_b1})), borderColor: '#F472B6', borderDash: [5, 5] }
                ]
            }, getChartOptions({ y: { beginAtZero: false, ticks: { color: '#9CA3AF' } } }, onZoomPan));
        };
        
        const fetchTripData = async () => {
            loadingIndicator.textContent = '正在從伺服器載入數據...';
            chartsContainer.style.display = 'none';
            try {
                const response = await fetch(`/api/trip_data?id=${tripId}`);
                if (!response.ok) {
                    throw new Error(`伺服器錯誤: ${response.status} ${response.statusText}`);
                }
                originalTripData = await response.json();
                if (originalTripData.error) {
                    throw new Error(originalTripData.error);
                }
                if (originalTripData.length === 0) {
                    throw new Error('找不到此行程的數據。');
                }
                
                exportBtn.href = `/api/trip/${tripId}/export`;
                
                redrawCharts();
                chartsContainer.style.display = 'block';
            } catch (error) {
                subtitle.textContent = `載入 Trip ID: ${tripId} 數據時發生錯誤`;
                loadingIndicator.textContent = `錯誤: ${error.message}`;
                console.error("Fetch error:", error);
            } finally {
                if (originalTripData.length > 0) {
                    loadingIndicator.style.display = 'none';
                }
            }
        };

        const aggregateDataByTime = (data, intervalSeconds = 1) => {
            if (!data || data.length === 0) return [];
            if (intervalSeconds <= 0) return data;

            const result = [];
            const intervalMillis = intervalSeconds * 1000;
            let currentGroup = [];
            let groupStartTime = new Date(data[0].timestamp).getTime();
            
            // Helper to average a group of data points
            const averageGroup = (group) => {
                if (group.length === 0) return null;
                const avg = { timestamp: group[0].timestamp }; // Use the first timestamp for the group
                const keys = Object.keys(group[0]);
                
                for (const key of keys) {
                    // We only average numerical data. Non-numerical data will take the value from the first point.
                    if (typeof group[0][key] === 'number') {
                        const sum = group.reduce((acc, item) => acc + (item[key] || 0), 0);
                        avg[key] = sum / group.length;
                    } else {
                        avg[key] = group[0][key];
                    }
                }
                return avg;
            };

            for (const point of data) {
                const pointTime = new Date(point.timestamp).getTime();
                if (pointTime < groupStartTime + intervalMillis) {
                    currentGroup.push(point);
                } else {
                    if (currentGroup.length > 0) {
                        result.push(averageGroup(currentGroup));
                    }
                    currentGroup = [point];
                    // Start a new time window from the current point's time
                    groupStartTime = pointTime;
                }
            }
            // Add the last group
            if (currentGroup.length > 0) {
                result.push(averageGroup(currentGroup));
            }
            return result;
        };
 
        // [修改] 事件監聽器現在需要處理多個圖表容器
        document.getElementById('charts-container').addEventListener('click', (e) => {
            const button = e.target.closest('button.toggle-btn');
            if (button) {
                button.classList.toggle('active');
                const chart = charts[button.dataset.chart];
                if (chart) {
                    chart.setDatasetVisibility(button.dataset.datasetIndex, !chart.isDatasetVisible(button.dataset.datasetIndex));
                    chart.update();
                }
            }
        });
        
        samplingInput.addEventListener('change', redrawCharts);
 
        fetchTripData();
    </script>
</body>
</html>
